-module(money).
-import(customer,[createThreads/3]).
-import(banks,[createBanksThreads/2]).

-export([start/1,master/4,display/3,requestToDisplayBalance/4, displayReport/2]).

start(Args) ->
    case Args of
        [CustomerFile, BankFile] ->
            {ok, CustomerData} = file:consult(CustomerFile),
            {ok, BankData} = file:consult(BankFile),
            io:format("Starting the banking application...~n"),
            io:format("~n"),
            io:format("Customer Objective: ~p~n", [CustomerData]),
            io:format("Bank Balance: ~p~n", [BankData]),
            io:format("~n"),
            io:format("**********The financial market is opening for the day*************~n"),
            io:format("~n"),
            io:format("Starting transaction log...~n"),
            io:format("~n"),
            Pid = spawn(money, master, [CustomerData, BankData, #{}, #{}]),
            Pid ! {data, "start"},
            ok;
        _ ->
            io:format("Invalid command-line arguments. Usage: erl -noshell -run money start <customer_file> <bank_file> -s init stop~n")
    end.

display(Max, Min, _) when Min > Max -> ok;
display(Max, Min, Data) when Max >= Min ->
    Row = lists:nth(Min, Data),
    Customer = element(1, Row),
    Amount = element(2, Row),
    io:fwrite("~s: objective ~p, received ~p~n", [Customer, Amount, Amount]),
    display(Max, Min + 1, Data).

requestToDisplayBalance(Max, Min, BData, BanksMap) when Min > Max -> ok;
requestToDisplayBalance(Max, Min, BData, BanksMap) when Max >= Min ->
    Row = lists:nth(Min, BData),
    Bank = element(1, Row),
    Amount = element(2, Row),
    Pid = maps:get(Bank, BanksMap),
    Pid ! {displayBalance},
    requestToDisplayBalance(Max, Min + 1, BData, BanksMap).

displayReportDebug(CData, BData) ->
    io:fwrite("CData: ~p~n", [CData]),  % Debug output to check CData contents
    displayReport(CData, BData).

displayReport(CData, BData) ->
    io:fwrite("** Banking Report **~n"),
    io:fwrite("Customers:~n"),
    lists:foreach(fun displayCustomer/2, CData),
    io:fwrite("-----~n"),
    displayTotals(CData),
    io:fwrite("Banks:~n"),
    lists:foreach(fun displayBank/1, BData),
    io:fwrite("-----~n"),
    displayTotals(BData),
    io:fwrite("The financial market is closing for the day...~n").

displayCustomer({Customer, Objective}, CData) ->
    io:fwrite("~s: objective ~p, received ~p~n", [Customer, Objective, Objective]).

displayBank({Bank, Original, Balance}) ->
    io:fwrite("~s: original ~p, balance ~p~n", [Bank, Original, Balance]).

displayTotals(Data) ->
    TotalObjective = lists:sum([Objective || {_, Objective} <- Data]),
    TotalReceived = lists:sum([Received || {_, Received} <- Data]),
    io:fwrite("Total: objective ~p, received ~p~n", [TotalObjective, TotalReceived]).

master(CData, BData, CustomerMaps, BanksMap) ->
    receive
        {data, "start"} ->
            io:fwrite("** Customers and loan objectives **~n"),
            display(length(CData), 1, CData),
            displayTotals(CData),
            io:fwrite("** Banks and financial resources **~n"),
            display(length(BData), 1, BData),
            displayTotals(BData),
            BankThreads = createBanksThreads(BData, self()),
            CustomerThreads = createThreads(CData, BankThreads, self()),
            timer:sleep(200),  % Sleep for 200 milliseconds
            master(CData, BData, CustomerThreads, BankThreads);
        {loanRequest, Customer, Amount, BankName} ->
            io:fwrite("? ~p requests a loan of ~p dollar(s) from ~p~n", [Customer, Amount, BankName]),
            master(CData, BData, CustomerMaps, BanksMap);
        {frombankApproved, BankName, Amount, Customer} ->
            io:fwrite("$ ~p approves a loan of ~p dollars from ~p~n", [BankName, Amount, Customer]),
            master(CData, BData, CustomerMaps, BanksMap);
        {frombankDisApproved, BankName, Amount, Customer} ->
            io:fwrite("$ ~p denies a loan of ~p dollars from ~p~n", [BankName, Amount, Customer]),
            master(CData, BData, CustomerMaps, BanksMap);
        {completed, Customer, Amount} ->
            io:fwrite("~p has reached the objective of ~p dollar(s). Woo Hoo!~n", [Customer, Amount]),
            UpdatedMap = maps:remove(Customer, CustomerMaps),
            Size = maps:size(UpdatedMap),
            if
                Size > 0 ->
                    master(CData, BData, UpdatedMap, BanksMap);
                Size == 0 ->
                    requestToDisplayBalance(length(BData), 1, BData, BanksMap),
                    displayReportDebug(CData, BData),  % Display the final reports
                    io:fwrite("All transactions completed. Exiting...~n"),
                    ok
            end;
        {notcompleted, Customer, LoanAmount} ->
            io:fwrite("~p has not reached the objective of ~p dollar(s). Boo Hoo!~n", [Customer, LoanAmount]),
            UpdatedMap = maps:remove(Customer, CustomerMaps),
            Size = maps:size(UpdatedMap),
            if
                Size > 0 ->
                    master(CData, BData, UpdatedMap, BanksMap);
                Size == 0 ->
                    requestToDisplayBalance(length(BData), 1, BData, BanksMap),
                    displayReportDebug(CData, BData),  % Display the final reports
                    io:fwrite("All transactions completed. Exiting...~n"),
                    ok
            end;
        {myBalance, BankName, BankBalance} ->
            io:fwrite("~p has ~p dollar(s) remaining.~n", [BankName, BankBalance]),
            master(CData, BData, CustomerMaps, BanksMap);
        Other ->
            io:fwrite(" "),
            master(CData, BData, CustomerMaps, BanksMap)
    end,

    displayReport(CData, BData).
